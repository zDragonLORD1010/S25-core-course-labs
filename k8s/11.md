# Kubernetes Secrets and Hashicorp Vault

## Kubernetes Secrets and Resource Management

### 1. Create a Secret Using kubectl:

```bash
egor@egor-100-HP:~/PycharmProjects/S25-core-course-labs/k8s$ kubectl create secret generic app-python-secret \
  --from-literal=APP_SECRET='secret-key' \
  --from-literal=APP_ENV='production'
secret/moscow-time-secret created
```

### 2. Verify and Decode Your Secret:

- Check the secret:

```bash
egor@egor-100-HP:~/PycharmProjects/S25-core-course-labs/k8s$ kubectl get secret app-python-secret -o yaml
apiVersion: v1
data:
  APP_ENV: cHJvZHVjdGlvbg==
  APP_SECRET: c2VjcmV0LWtleQ==
kind: Secret
metadata:
  creationTimestamp: "2025-03-08T14:50:12Z"
  name: app-python-secret
  namespace: default
  resourceVersion: "8234"
  uid: 2a5bd65a-81ba-49d6-9804-b6ed61ca8b10
type: Opaque
```

- Decode secrets:

```bash
egor@egor-100-HP:~/PycharmProjects/S25-core-course-labs/k8s$ echo c2VjcmV0LWtleQ== | base64 --decode
secret-key
```

```bash
egor@egor-100-HP:~/PycharmProjects/S25-core-course-labs/k8s$ echo cHJvZHVjdGlvbg== | base64 --decode
production
```

### 3. Manage Secrets with Helm:

- Deploy with helm:

```bash
egor@egor-100-HP:~/PycharmProjects/S25-core-course-labs/k8s$ helm install app-python ./app-python
NAME: app-python
LAST DEPLOYED: Fri Mar  8 15:00:17 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
```

- Verify the pods and secrets:

```bash
egor@egor-100-HP:~/PycharmProjects/S25-core-course-labs/k8s$ kubectl get pods
NAME                          READY   STATUS      RESTARTS   AGE
pre-install-hook-a62db        0/1     Completed   0          87s
app-python-pgk7qa98dc-o8128   1/1     Running     0          16s
```

```bash
egor@egor-100-HP:~/PycharmProjects/S25-core-course-labs/k8s$ kubectl exec app-python-pgk7qa98dc-o8128 -- printenv | grep APP_
APP_SECRET=secret-key
APP_ENV=production
```

## Vault Secret Management System

### 1. Install vault using helm chart:

```bash
egor@egor-100-HP:~/PycharmProjects/S25-core-course-labs/k8s$ helm repo add hashicorp https://helm.releases.hashicorp.com
"hashicorp" has been added to your repositories
```

```bash
egor@egor-100-HP:~/PycharmProjects/S25-core-course-labs/k8s$ helm repo update
Hang tight while we grab the latest from your chart repositories...
...Successfully got an update from the "hashicorp" chart repository
Update Complete. ⎈Happy Helming!⎈
```

```bash
egor@egor-100-HP:~/PycharmProjects/S25-core-course-labs/k8s$ helm install vault hashicorp/vault --set "server.dev.enabled=true"
NAME: vault
LAST DEPLOYED: Fri Mar  8 15:33:41 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
Thank you for installing HashiCorp Vault!
```

- Check the pods:

```bash
egor@egor-100-HP:~/PycharmProjects/S25-core-course-labs/k8s$ kubectl get pods
NAME                                    READY   STATUS              RESTARTS   AGE
pre-install-hook-a62db                  0/1     Completed           0          35m
app-python-pgk7qa98dc-o8128             1/1     Running             0          35m
vault-0                                 0/1     ContainerCreating   0          63s
vault-agent-injector-ba35fdacg3-gc34a   1/1     Running             0          53s
```

### 2. Configure helm chart:

- Configure the vault:

```bash
egor@egor-100-HP:~/PycharmProjects/S25-core-course-labs/k8s$ kubectl exec -it vault-0 -- /bin/sh
```

```bash
/ $ vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/
```

```bash
/ $ vault kv put internal/database/config username="db-readonly-username" password="db-secret-password"
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-08T15:44:21.882622431Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
```

```bash
/ $ vault kv get internal/database/config
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-08T15:44:21.882622431Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    db-secret-password
username    db-readonly-username
```

- Configure a kubernetes authentication:

```bash
/ $ vault auth enable kubernetes
Success! Enabled kubernetes auth method at: kubernetes/
```

```bash
/ $ vault write auth/kubernetes/config \
    kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443" \
    token_reviewer_jwt="$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)" \
    kubernetes_ca_cert=@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt \
    issuer="https://kubernetes.default.svc.cluster.local"
Success! Data written to: auth/kubernetes/config
```

- Create a policy:

```bash
/ $ vault policy write app-python - <<EOF
path "secret/data/app-python/*" {
  capabilities = ["read"]
}
EOF
Success! Uploaded policy: app-python
```

```bash
/ $ vault write auth/kubernetes/role/app-python \
    bound_service_account_names=app-python \
    bound_service_account_namespaces=default \
    policies=app-python \
    ttl=24h
Success! Data written to: auth/kubernetes/role/app-python
```

### 3. Implement vault secrets:

- Store secrets in vault:

```bash
/ $ vault kv put secret/app-python/config \
    app_secret="vault-managed-secret" \
    app_env="production-vault"
Success! Data written to: secret/app-python/config
```

- Enable KV secrets:

```bash
egor@egor-100-HP:~/PycharmProjects/S25-core-course-labs/k8s$ kubectl exec -it vault-0 -- sh -c 'vault secrets enable -path=secret kv-v2'
Success! Enabled kv-v2 secrets engine at: secret/
```

- Check the vault:

```bash
$ helm upgrade app-python ./app-python
Release "app-python" has been upgraded. Happy Helming!
```

- Check the pods:

```bash
$ kubectl get pods
NAME                                    READY   STATUS      RESTARTS   AGE
pre-install-hook-a62db                  0/1     Completed   0          72m
app-python-a39sv3df2-a4db8              1/1     Running     0          53s
vault-0                                 1/1     Running     0          38m
vault-agent-injector-ba35fdacg3-gc34a   1/1     Running     0          38m
```

- Check the secrets:

```bash
egor@egor-100-HP:~/PycharmProjects/S25-core-course-labs/k8s$ kubectl exec -it app-python-a39sv3df2-a4db8 -- cat /vault/secrets/config
Defaulted container "app-python" out of: app-python, vault-agent, vault-agent-init (init)
data: map[app_env:production-vault app_secret:vault-managed-secret]
metadata: map[created_time:2025-03-08T16:02:56.849671395Z custom_metadata:<nil> deletion_time: destroyed:false version:1]
```

```bash
egor@egor-100-HP:~/PycharmProjects/S25-core-course-labs/k8s$ kubectl exec -it app-python-a39sv3df2-a4db8 -- df -h | grep vault
Defaulted container "app-python" out of: app-python, vault-agent, vault-agent-init (init)
tmpfs                   640.0M      4.0K    640.0M   0% /vault/secrets
```